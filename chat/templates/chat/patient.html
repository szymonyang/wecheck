<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Chat Room</title>
</head>

<body>
    <h2>Quro Chat - Patient Site</h2>
    <p id="start-message">You are in the queue. A doctor will be with you soon.</p>
    <div id="chatArea" hidden>
        <textarea id="chat-log" cols="100" rows="20"></textarea><br />
        <input id="chat-message-input" type="text" size="100" /><br />
        <input id="chat-message-submit" type="button" value="Send" />
    </div>
</body>
<script>
const browserTabId = Math.random().toString(36).substring(2);
var chatSocket = new WebSocket('ws://' + window.location.host + '/ws/patient?browser=' + browserTabId);

chatSocket.onmessage = function(e) {
    var data = JSON.parse(e.data);

    if (data.action == 'start_chat'){
        document.querySelector('#chatArea').hidden = false;
        document.querySelector('#start-message').hidden = true;
    } else if (data.action == 'queue'){
        document.querySelector('#start-message').innerHTML = data.message;
    } else if (data.action == 'reserve'){
        document.querySelector('#start-message').innerHTML = "A doctor is viewing your case now.";
    } else if (data.action == 'chat'){
        document.querySelector('#chat-log').value += (data.message + '\n');
    } else if (data.action == 'doctor_left'){
        alert(data.message);
    } else if (data.action == 'end_chat'){
        document.querySelector('#chat-log').value += ('The doctor has ended the chat\n');
        document.querySelector('#chat-message-input').hidden = true;
        document.querySelector('#chat-message-submit').hidden = true;
    }
};

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
};

document.querySelector('#chat-message-input').focus();
document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) { // enter, return
        document.querySelector('#chat-message-submit').click();
    }
};
document.querySelector('#chat-message-submit').onclick = function(e) {
    var messageInputDom = document.querySelector('#chat-message-input');
    var message = messageInputDom.value;
    chatSocket.send(JSON.stringify({'action':'chat', 'message': message}));
    messageInputDom.value = '';
};
</script>

</html>